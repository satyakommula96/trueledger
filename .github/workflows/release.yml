name: TrueLedger Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_CHANNEL: stable

# ============================================================
# LINUX (.deb)
# ============================================================
jobs:
  build-linux:
    name: Linux (.deb)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libsecret-1-dev \
            libjsoncpp-dev libsqlcipher-dev libssl-dev

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - run: flutter pub get

      - id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - run: |
          chmod +x scripts/create_deb.sh
          VERSION=${{ steps.version.outputs.VERSION }} ./scripts/create_deb.sh

      - uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: TrueLedger.deb

# ============================================================
# ANDROID (APK + AAB)
# ============================================================
  build-android:
    name: Android (APK + AAB)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - run: flutter pub get

      - id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Configure Android Signing
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - run: flutter build appbundle --release --build-name=${{ steps.version.outputs.VERSION }}
      - run: flutter build apk --release --build-name=${{ steps.version.outputs.VERSION }}

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

# ============================================================
# WINDOWS (EXE + MSIX + MSI)
# ============================================================
  build-windows:
    name: Windows (EXE + MSIX + MSI)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Install WiX Toolset
        run: choco install wixtoolset -y

      - id: version
        shell: bash
        run: |
          RAW_VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$RAW_VERSION" >> $GITHUB_OUTPUT
          # Extract semantic version part (before +)
          CLEAN_VERSION=$(echo "$RAW_VERSION" | cut -d'+' -f1)
          echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - run: flutter build windows --release --build-name=${{ steps.version.outputs.VERSION }}

      # ---------------- EXE ----------------
      - name: Build EXE
        run: |
          iscc /DAppVersion=${{ steps.version.outputs.VERSION }} scripts/windows_setup.iss

      # ---------------- MSIX ----------------
      - name: Build MSIX
        run: flutter pub run msix:create --version ${{ steps.version.outputs.CLEAN_VERSION }}.0

      # ---------------- MSI (WiX) ----------------
      - name: Build MSI
        shell: bash
        run: |
          set -e
          test -f windows/installer/TrueLedger.wxs
          candle -arch x64 -dAppVersion=${{ steps.version.outputs.CLEAN_VERSION }} windows/installer/TrueLedger.wxs
          light TrueLedger.wixobj -o TrueLedger.msi

      - uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: build/windows/x64/installer/TrueLedger.exe

      - uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          path: build/windows/x64/runner/Release/TrueLedger.msix

      - uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: TrueLedger.msi

# ============================================================
# macOS (DMG)
# ============================================================
  build-macos:
    name: macOS (DMG)
    runs-on: macos-14
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - run: |
          brew install sqlcipher
          flutter config --enable-macos-desktop

      - run: flutter pub get

      - id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - run: |
          chmod +x scripts/create_dmg.sh
          VERSION=${{ steps.version.outputs.VERSION }} ./scripts/create_dmg.sh

      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: TrueLedger.dmg

# ============================================================
# iOS (Unsigned IPA)
# ============================================================
  build-ios:
    name: iOS (Unsigned IPA)
    runs-on: macos-14
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - run: flutter pub get
      - run: flutter precache --ios

      - id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - run: |
          flutter build ios --release --no-codesign --build-name=${{ steps.version.outputs.VERSION }}
          mkdir Payload
          cp -r build/ios/iphoneos/Runner.app Payload/TrueLedger.app
          zip -r TrueLedger.ipa Payload

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: TrueLedger.ipa

# ============================================================
# RELEASE
# ============================================================
  release:
    name: Publish Release
    needs:
      - build-linux
      - build-android
      - build-windows
      - build-macos
      - build-ios
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - run: |
          mkdir out
          mv dist/linux-deb/TrueLedger.deb out/TrueLedger_${{ steps.version.outputs.VERSION }}.deb
          mv dist/android-apk/app-release.apk out/TrueLedger_${{ steps.version.outputs.VERSION }}_unsigned.apk
          mv dist/android-aab/app-release.aab out/TrueLedger_${{ steps.version.outputs.VERSION }}_signed.aab
          mv dist/windows-exe/TrueLedger.exe out/TrueLedger_${{ steps.version.outputs.VERSION }}_unsigned.exe
          mv dist/windows-msix/TrueLedger.msix out/TrueLedger_${{ steps.version.outputs.VERSION }}_signed.msix
          mv dist/windows-msi/TrueLedger.msi out/TrueLedger_${{ steps.version.outputs.VERSION }}.msi
          mv dist/macos-dmg/TrueLedger.dmg out/TrueLedger_${{ steps.version.outputs.VERSION }}.dmg
          mv dist/ios-ipa/TrueLedger.ipa out/TrueLedger_${{ steps.version.outputs.VERSION }}_unsigned.ipa

      - uses: softprops/action-gh-release@v2
        with:
          files: out/*
          generate_release_notes: true
      
      - run: |
          mkdir -p pages/${{ steps.version.outputs.VERSION }}
          cp out/* pages/${{ steps.version.outputs.VERSION }}
          touch pages/.nojekyll

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: pages
          keep_files: true