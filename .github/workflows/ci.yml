name: TrueLedger CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: stable

jobs:
# -------------------------
# UNIT + ANALYSIS (FAST)
# -------------------------
  test:
    name: Unit & Analysis (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: dart format --output=none --set-exit-if-changed .
      - run: flutter analyze

      - name: Run tests
        run: flutter test

# -------------------------
# LINUX INTEGRATION
# -------------------------
  integration-linux:
    name: Integration (Linux)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get

      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libsecret-1-dev \
            libjsoncpp-dev libsqlite3-dev libsqlcipher-dev \
            libssl-dev xvfb

      - run: xvfb-run flutter test integration_test/app_test.dart -d linux --timeout 10m

# -------------------------
# ANDROID INTEGRATION
# -------------------------
  integration-android:
    name: Integration (Android)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get

      - uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          profile: Nexus 6
          disable-animations: true
          script: flutter test integration_test/app_test.dart --timeout 10m

# -------------------------
# iOS INTEGRATION (HARD MODE)
# -------------------------
  integration-ios:
    name: Integration (iOS)
    needs: test
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter dependencies
        run: |
          flutter pub get
          flutter precache --ios
          cd ios && pod install

      - name: Run iOS Integration Test
        run: |
          set -euo pipefail

          SIM_NAME="FlutterTester"
          DEVICE_TYPE="iPhone 15"

          RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | grep available | tail -1 | awk -F '[()]' '{print $2}')
          echo "Using runtime: $RUNTIME"

          UDID=$(xcrun simctl list devices | grep "$SIM_NAME" | awk -F '[()]' '{print $2}' | head -n 1)

          if [ -z "$UDID" ]; then
            UDID=$(xcrun simctl create "$SIM_NAME" "$DEVICE_TYPE" "$RUNTIME")
          else
            xcrun simctl shutdown "$UDID" || true
            xcrun simctl erase "$UDID"
          fi

          xcrun simctl boot "$UDID"
          xcrun simctl bootstatus "$UDID" -b

          echo "Waiting for simulator readiness..."

          until xcrun simctl spawn "$UDID" launchctl print system >/dev/null 2>&1; do
            sleep 5
          done

          until xcrun simctl spawn "$UDID" defaults read com.apple.springboard >/dev/null 2>&1; do
            sleep 5
          done

          flutter drive \
            --driver=test_driver/integration_test.dart \
            --target=integration_test/app_test.dart \
            -d "$UDID" \
            --timeout 15m

# -------------------------
# macOS DESKTOP INTEGRATION
# -------------------------
  integration-macos:
    name: Integration (macOS)
    needs: test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup macOS Environment
        run: |
          brew install sqlcipher
          flutter config --enable-macos-desktop

      - run: flutter pub get
      - run: flutter test integration_test/app_test.dart -d macos --timeout 10m

# -------------------------
# WINDOWS INTEGRATION
# -------------------------
  integration-windows:
    name: Integration (Windows)
    needs: test
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: flutter test integration_test/app_test.dart -d windows --timeout 10m