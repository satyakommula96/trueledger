name: TrueLedger CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: stable

jobs:
# -------------------------
# UNIT + ANALYSIS (FAST)
# -------------------------
  test:
    name: Unit & Analysis (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v6

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: dart format --output=none --set-exit-if-changed .
      - run: flutter analyze

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Install lcov for Coverage Report
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Report Coverage
        if: matrix.os == 'ubuntu-latest'
        uses: zgosalvez/github-actions-report-lcov@v7
        with:
          coverage-files: coverage/lcov.info
          minimum-coverage: 0
          github-token: ${{ secrets.GITHUB_TOKEN }}

# -------------------------
# LINUX INTEGRATION
# -------------------------
  integration-linux:
    name: Integration (Linux)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get

      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libsecret-1-dev \
            libjsoncpp-dev libsqlite3-dev libsqlcipher-dev \
            libssl-dev xvfb libglu1-mesa

      - run: xvfb-run -s "-screen 0 1280x720x24" flutter test integration_test/app_test.dart -d linux --timeout 20m

# -------------------------
# ANDROID INTEGRATION
# -------------------------
  integration-android:
    name: Integration (Android)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get

      - uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          profile: Nexus 6
          disable-animations: true
          script: flutter test integration_test/app_test.dart --timeout 25m

# -------------------------
# iOS INTEGRATION (HARD MODE)
# -------------------------
  integration-ios:
    name: Integration (iOS)
    needs: test
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter dependencies
        run: |
          flutter pub get
          flutter precache --ios
          cd ios && pod install

      - name: Run iOS Integration Test
        run: |
          set -euo pipefail

          SIM_NAME="FlutterTester"
          DEVICE_TYPE="iPhone 15"

          # Find device UDID safely (returns empty if not found, instead of exiting shell)
          UDID=$(xcrun simctl list devices | grep "$SIM_NAME" | head -n 1 | awk -F '[()]' '{print $2}' || true)

          if [ -z "$UDID" ] || [ ${#UDID} -lt 10 ]; then
            echo "Creating new simulator: $DEVICE_TYPE"
            UDID=$(xcrun simctl create "$SIM_NAME" "$DEVICE_TYPE" || xcrun simctl create "$SIM_NAME" "iPhone 15")
          else
            echo "Found existing simulator: $UDID. Cleaning..."
            xcrun simctl shutdown "$UDID" || true
            xcrun simctl erase "$UDID" || true
          fi

          echo "Booting simulator ($UDID)..."

          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

          echo "Waiting for simulator readiness..."

          NEXT_WAIT_TIME=0
          until xcrun simctl spawn "$UDID" launchctl print system >/dev/null 2>&1; do
            sleep 5
            NEXT_WAIT_TIME=$((NEXT_WAIT_TIME + 5))
            echo "Waiting for system... ($NEXT_WAIT_TIME s)"
            if [ $NEXT_WAIT_TIME -gt 300 ]; then echo "Timeout waiting for system"; exit 1; fi
          done

          NEXT_WAIT_TIME=0
          until xcrun simctl spawn "$UDID" defaults read com.apple.springboard >/dev/null 2>&1; do
            sleep 5
            NEXT_WAIT_TIME=$((NEXT_WAIT_TIME + 5))
            echo "Waiting for springboard... ($NEXT_WAIT_TIME s)"
            if [ $NEXT_WAIT_TIME -gt 300 ]; then echo "Timeout waiting for springboard"; exit 1; fi
          done

          echo "Simulator ready. Starting tests..."

          # Using 'flutter test' instead of 'flutter drive' for better stability with modern integration_test package
          flutter test integration_test/app_test.dart \
            -d "$UDID" \
            --timeout 25m \
            --no-pub

# -------------------------
# macOS DESKTOP INTEGRATION
# -------------------------
  integration-macos:
    name: Integration (macOS)
    needs: test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup macOS Environment
        run: |
          brew install sqlcipher
          flutter config --enable-macos-desktop

      - run: flutter pub get
      - run: flutter test integration_test/app_test.dart -d macos --timeout 25m

# -------------------------
# WINDOWS INTEGRATION
# -------------------------
  integration-windows:
    name: Integration (Windows)
    needs: test
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: flutter test integration_test/app_test.dart -d windows --timeout 20m